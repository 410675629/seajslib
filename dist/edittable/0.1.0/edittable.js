/* 2013-04-11 */
(function(t){function e(e,i){for(var a,n,r=e[0].rows,l=r[0].cells,d=1,o=r.length;o>d;d++){n=r[d].cells;for(var s=0,c=n.length;c>s;s++)a=t(l[s]).attr("grid"),a&&i[a]&&t(n[s]).attr("grid",a)}e.find("td[grid]")}function i(i,r){e(i,r),i.find("td[grid]").addClass("edit-cell"),"dblclick"===o.action?i.delegate("td[grid]","mousedown",function(){}):o.action="click",i.delegate("td[grid]",o.action,function(){var e=t(this),i=e.attr("grid"),l=t.extend({},o,r[i]),d=a(e,l);return"select"===l.type&&d.change(function(){n(e,l,d,r)}),d.blur(function(){n(e,l,d,r)}),!1})}function a(e,i){var a=e.text(),n="99",r="";if("select"===i.type){var l=i.values;r='<select _value="'+a+'">';for(var d in l)r+='<option value="'+d+'">'+l[d]+"</option>";r+="</select>",setTimeout(function(){e.find("option").each(function(){var e=t(this);e.text()==a&&e.attr("selected",!0)})},0)}else/^(text|int|qq|email|moble|date)$/i.test(i.type)?r='<input style="width:'+n+'%;height:99%;margin:0;border:0;" type="text" value="'+a+'"  _value="'+a+'"/>':"textarea"===i.type&&(r='<textarea style="width:'+n+'%;height:95%;margin:0;border:0;" _value="'+a+'">'+a+"</textarea>",setTimeout(function(){e.find("textarea").each(function(){var e=t(this);40>e.height()&&e.height(40)})},0));return e.html(r),e.find(":input").focus()}function n(t,e,i,a){var n=r(t,e,i,a);n?alert(n):(t.addClass("edit-cell-save"),new l(t,e,i,a).post())}function r(e,i,a){var n=t.trim(a.val());return"function"==typeof i.check?i.check(n):/^int$/i.test(i.type)&&!/^-?\d+$/i.test(n)?"类型错误，请输入数字":/^unsigned$/i.test(i.type)&&!/^\d+$/i.test(n)?"类型错误，请输入数字":/^qq$/i.test(i.type)&&!/^\d{5,13}$/i.test(n)?"类型错误，请输入QQ号":/^moble$/i.test(i.type)&&!/^\d{11}$/i.test(n)?"类型错误，请输入手机号":/^date$/i.test(i.type)&&isNaN(Date.parse(n))?"类型错误，请输入日期格式的内容":/^email$/i.test(i.type)&&!d.test(n)?"类型错误，请输入email格式的内容":void 0}function l(t,e,i,a){this.td=t,this.op=e,this.input=i,this.option=a}define("edittable/0.1.0/edittable",[],function(){return i});var d=/^[a-z0-9]([a-z0-9]*[-_.]?[a-z0-9]+)*@([a-z0-9]*[-_]?[a-z0-9]+)+[\.][a-z]{2,3}([\.][a-z]{2,3})?$/i,o=(t(window),t(document),{url:"",id:"id",type:"text",values:null,method:"GET",dataType:"json",postData:{itemid:0,key:"",value:"",ajax:1,val:"",formhash:"",modifysubmit:"yes",datatype:"json",in_ajax:1},action:"dblclick",showError:!0,callback:function(t){var e="";return t&&"object"==typeof t&&t.status!==void 0&&(1==t.status||t.msg&&(e=t.msg)),e}});t("head").append("<style>.edit-cell{background: url(http://www.huimg.cn/xiaobaike/images/public/girdbtbg.gif) no-repeat bottom left;}.edit-cell-save{}.edit-cell-success{}.edit-cell-error{}</style>"),t.fn.extend({editTable:function(e){i(t(this),e)}}),t.editTable=function(t,e){i(t,e)},t.editTable.setDefaults=function(e){o=t.extend(o,e)},t.editTable.setDefault=function(t,e){o[t]=e},l.prototype.post=function(){var e=this.td,i=this.op,a=this.input,n=this.option,r=t.trim(a.val()),l="",d=a.attr("_value");if(a.is("select")&&(l=r,r=a.children("option[value="+r+"]").text(),a.unbind("change")),a.unbind("blur"),e.text(r),r!=d){var o=i.url,s=e.attr("grid"),c=i.postData,u=i.method||"GET",f=i.dataType||"json",h=e.parent().find("td[grid="+i.id+"]");c.itemid=h.size()?h.text():e.parent().find("input[name="+i.id+"]").val(),c.key=s,c.dataType=f,c[s]=l||r,c.value=l||r,c.val=s,c.formhash=n.formhash,encodeURI(r).length>900&&(u="POST"),t.ajax({url:o,type:u,cache:!1,data:c,dataType:f,success:function(t){var a=i.callback(t);a?(e.addClass("edit-cell-error"),e.text(d),i.showError&&alert(a)):e.addClass("edit-cell-success")},error:function(t,a){i.showError&&("timeout"===a?alert("提示：连接超时，保存失败"):"parsererror"===a?alert("提示：JSON 解析错误，保存失败"):alert("提示：未知错误，保存失败")),e.text(d),e.addClass("edit-cell-error")}})}}})(jQuery);