/*! Bkeditor - v0.8.0 - 2013-05-24
* https://github.com/daixianfeng/a
* Copyright (c) 2013 daixianfeng; Licensed MIT */
(function(){function e(e,t){var n=r.nodeIndex;e=e.duplicate(),e.collapse(t);var i=e.parentElement();if(!i.hasChildNodes())return{container:i,offset:0};for(var o,a,s=i.children,l=e.duplicate(),d=0,c=s.length-1,f=-1;c>=d;){f=Math.floor((d+c)/2),o=s[f],l.moveToElementText(o);var u=l.compareEndPoints("StartToStart",e);if(u>0)c=f-1;else{if(!(0>u))return{container:i,offset:n(o)};d=f+1}}if(-1==f){if(l.moveToElementText(i),l.setEndPoint("StartToStart",e),a=l.text.replace(/(\r\n|\r)/g,"\n").length,s=i.childNodes,!a)return o=s[s.length-1],{container:o,offset:o.nodeValue.length};for(var m=s.length;a>0;)a-=s[--m].nodeValue.length;return{container:s[m],offset:-a}}if(l.collapse(u>0),l.setEndPoint(u>0?"StartToStart":"EndToStart",e),a=l.text.replace(/(\r\n|\r)/g,"\n").length,!a){if(p===void 0)var p=window.parent.DTD;return p.$empty[o.tagName]||p.$nonChild[o.tagName]?{container:i,offset:n(o)+(u>0?0:1)}:{container:o,offset:u>0?0:o.childNodes.length}}for(;a>0;)try{var h=o;o=o[u>0?"previousSibling":"nextSibling"],a-=o.nodeValue.length}catch(g){return{container:i,offset:n(h)}}return{container:o,offset:u>0?-a:o.nodeValue.length+a}}function t(t,n){if(t.item)n.selectNode(t.item(0));else{var r=e(t,!0);n.setStart(r.container,r.offset),0!=t.compareEndPoints("StartToEnd",t)?(r=e(t,!1),n.setEnd(r.container,r.offset)):n.collapse(!0)}return n}function n(e){this._document=e;var t=this;e.attachEvent("onselectionchange",function(){t._selectionChangeHandler()})}var r={isBody:function(e){return e&&1==e.nodeType&&"body"==e.tagName.toLowerCase()},nodeIndex:function(e){for(var t=0;e=e.previousSibling;t++)continue;return t},findParent:function(e){return r.isBody(e)?null:e.parentNode},findParents:function(e,t){for(var n=[];null!==e&&e!==t;)n.push(e),e=r.findParent(e);return n},getCommonAncestor:function(e){var t=e.startContainer,n=e.endContainer;if(e.startOffset,e.endOffset,t===n)return 1==t.nodeType?t:3==t.nodeType?t.parentNode:t;for(var r=[t],i=[n],o=t,a=-1;o=o.parentNode;){if(o===n)return o;r.push(o)}for(o=n;o=o.parentNode;){if(o===t)return o;i.push(o)}for(r.reverse(),i.reverse();a++,r[a]===i[a];);return 0==a?null:r[a-1]},isDataNode:function(e){return e&&null!==e.nodeValue&&null!==e.data},isAncestorOf:function(e,t){return!r.isDataNode(e)&&(e.contains(r.isDataNode(t)?t.parentNode:t)||t.parentNode==e)},isAncestorOrSelf:function(e,t){return r.isAncestorOf(e,t)||e==t},getNodeLength:function(e){return r.isDataNode(e)?e.length:e.childNodes.length},splitDataNode:function(e,t){if(!r.isDataNode(e))return!1;var n=e.cloneNode(!1);e.deleteData(t,e.length),n.deleteData(0,t),e.parentNode.insertBefore(n,e.nextSibling)},pushNode:function(e,t,n){for(var i=e.firstChild;i;)(i.nodeType===n||n===void 0)&&t.push(i),r.pushNode(i,t,n),i=i.nextSibling}},i={convertToDOMRange:function(e,t){function n(e,n,r){var i=t.createElement("a"),o=n.duplicate();o.collapse(r);var a=o.parentElement();do a.insertBefore(i,i.previousSibling),o.moveToElementText(i);while(o.compareEndPoints(r?"StartToStart":"StartToEnd",n)>0&&i.previousSibling);-1==o.compareEndPoints(r?"StartToStart":"StartToEnd",n)&&i.nextSibling?(o.setEndPoint(r?"EndToStart":"EndToEnd",n),e[r?"setStart":"setEnd"](i.nextSibling,o.text.length)):e[r?"setStartBefore":"setEndBefore"](i),i.parentNode.removeChild(i)}var r=new DOMRange(t);return n(r,e,!0),n(r,e,!1),r},convertFromDOMRange:function(e){function t(e,t,n){var i=t[n?"startContainer":"endContainer"],o=t[n?"startOffset":"endOffset"],a=0,s=r.isDataNode(i)?i:i.childNodes[o],l=r.isDataNode(i)?i.parentNode:i;(3==i.nodeType||4==i.nodeType)&&(a=o);var d=t._document.createElement("a");s?l.insertBefore(d,s):l.appendChild(d);var c=t._document.body.createTextRange();c.moveToElementText(d),d.parentNode.removeChild(d),e.setEndPoint(n?"StartToStart":"EndToStart",c),e[n?"moveStart":"moveEnd"]("character",a)}var n=e._document.body.createTextRange();return t(n,e,!1),t(n,e,!0),n}};document.createNodeIterator=function(e,t){var n=[],i=e.firstChild;for(e.nextNode=function(){return n.shift()};i;)(i.nodeType===t||t===void 0)&&n.push(i),r.pushNode(i,n,t),i=i.nextSibling;return e},document.createRange=function(){var e=new DOMRange(document),t=e._index;return DOMRange._rangeQuery[t]=e,e},DOMRange=function(e){this._document=e,this._index=DOMRange._rangeQuery.length,this.startContainer=e,this.endContainer=e,this.startOffset=0,this.endOffset=0,this.commonAncestorContainer=e,this.collapsed=!0,this._startBefore=e,this._startAfter=e,this._endBefore=e,this._endAfter=e},DOMRange._rangeQuery=[],DOMRange.START_TO_START=0,DOMRange.START_TO_END=1,DOMRange.END_TO_END=2,DOMRange.END_TO_START=3,DOMRange._refreshRange=function(e){for(var t=DOMRange._rangeQuery,n=t.length,r=0;n>r;r++)if(e!==r){var i=t[r],o=i._document,a=!1,s=!1;i&&i.startContainer!==o&&i.endContainer!==o&&(i.startContainer&&3!==i.startContainer.nodeType?(i.startContainer.childNodes[i.startOffset-1]?i.startContainer.childNodes[i.startOffset-1]!==i._startBefore&&(a=!0):"firstChild"!==i._startBefore&&(a=!0),i.startContainer.childNodes[i.startOffset]?i.startContainer.childNodes[i.startOffset]!==i._startAfter&&(a=!0):"lastChild"!==i._startAfter&&(a=!0),"text"===i._startAfter&&(a=!1),a===!0&&("lastChild"===i._startAfter?i.startOffset=i.startContainer.childNodes.length:i._startAfter&&i._startAfter.parentNode===i.startContainer?i.setStartBefore(i._startAfter):"firstChild"===i._startBefore?i.startOffset=0:i._startBefore&&i._startBefore.parentNode===i.startContainer?i.setStartAfter(i._startBefore):(i.startContainer=o,i.startOffset=0))):i.startContainer||(i.startContainer=o,i.startOffset=0),i.endContainer&&3!==i.endContainer.nodeType?(i.endContainer.childNodes[i.endOffset-1]?i.endContainer.childNodes[i.endOffset-1]!==i._endBefore&&(s=!0):"firstChild"!==i._endBefore&&(s=!0),i.endContainer.childNodes[i.endOffset]?i.endContainer.childNodes[i.endOffset]!==i._endAfter&&(s=!0):"lastChild"!==i._endAfter&&(s=!0),"text"===i._endBefore&&(s=!1),s===!0&&("firstChild"===i._endBefore?i.endOffset=0:i._endBefore&&i._endBefore.parentNode===i.endContainer?i.setEndAfter(i._endBefore):"lastChild"===i._endAfter?i.endOffset=i.endContainer.childNodes.length:i._endAfter&&i._endAfter.parentNode===i.endContainer?i.setEndBefore(i._endAfter):(i.endContainer=o,i.endOffset=0))):i.endContainer||(i.endContainer=o,i.endOffset=0))}},DOMRange.prototype={START_TO_START:0,START_TO_END:1,END_TO_END:2,END_TO_START:3,_refreshProperties:function(){this.collapsed=this.startContainer==this.endContainer&&this.startOffset==this.endOffset,this.commonAncestorContainer=r.getCommonAncestor(this),3!==this.startContainer.nodeType?(this._startBefore=this.startContainer.childNodes[this.startOffset-1]?this.startContainer.childNodes[this.startOffset-1]:"firstChild",this._startAfter=this.startContainer.childNodes[this.startOffset]?this.startContainer.childNodes[this.startOffset]:"lastChild"):this._startBefore=this._startAfter="text",3!==this.endContainer.nodeType?(this._endBefore=this.endContainer.childNodes[this.endOffset-1]?this.endContainer.childNodes[this.endOffset-1]:"firstChild",this._endAfter=this.endContainer.childNodes[this.endOffset]?this.endContainer.childNodes[this.endOffset]:"lastChild"):this._endBefore=this._endAfter="text"},setStart:function(e,t){this.startContainer=e,this.startOffset=t,this._refreshProperties()},setEnd:function(e,t){this.endContainer=e,this.endOffset=t,this._refreshProperties()},setStartBefore:function(e){this.setStart(e.parentNode,r.nodeIndex(e))},setStartAfter:function(e){this.setStart(e.parentNode,r.nodeIndex(e)+1)},setEndBefore:function(e){this.setEnd(e.parentNode,r.nodeIndex(e))},setEndAfter:function(e){this.setEnd(e.parentNode,r.nodeIndex(e)+1)},selectNode:function(e){this.setStartBefore(e),this.setEndAfter(e)},selectNodeContents:function(e){this.setStart(e,0),this.setEnd(e,r.getNodeLength(e))},collapse:function(e){e?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset),this._refreshProperties()},deleteContents:function(){var e=!0,t=!1;this._optContents(e,t)},cloneContents:function(){var e=!1,t=!0;return this._optContents(e,t)},extractContents:function(){var e=!0,t=!0;return this._optContents(e,t)},_optContents:function(e,t){var n=this.startContainer,i=this.endContainer,o=this.startOffset,a=this.endOffset,s=this.commonAncestorContainer;if(frag=document.createDocumentFragment(),tmpStart={},tmpEnd={},startType=!1,endType=!1,this.collapsed)return frag;if(3===n.nodeType&&(startType=!0),3===i.nodeType&&(endType=!0),n===i&&startType&&endType){var l=n.nodeValue.slice(o,a),d=document.createTextNode(l);if(e){var c=n.nodeValue.slice(0,o),f=n.nodeValue.slice(a),u=document.createTextNode(c),m=document.createTextNode(f);n.parentNode.replaceChild(m,n),m.parentNode.insertBefore(u,m),this.setStart(m.parentNode,r.nodeIndex(u)+1),this.collapse(!0)}return frag.appendChild(d),t?frag:void 0}if(startType){var l=n.nodeValue.slice(o),d=document.createTextNode(l);e&&(n.nodeValue=n.nodeValue.slice(0,o)),o=r.nodeIndex(n),n=n.parentNode}if(endType){var p=i.nodeValue.slice(0,a),h=document.createTextNode(p);e&&(i.nodeValue=i.nodeValue.slice(a)),a=r.nodeIndex(i)+1,i=i.parentNode}var g=r.findParents(n,s),b=r.findParents(i,s),v=n.childNodes[o],y=i.childNodes[a-1];g.unshift(v),b.unshift(y),tmpStart=g.pop(),tmpEnd=b.pop();var w=tmpStart.nextSibling;tmpStart===tmpEnd&&(w=null);var C=frag,E=r.nodeIndex(tmpStart);for((0!==g.length||startType)&&(E+=1);"object"==typeof tmpStart;){if(tmpStart===v){if(!startType){if(tmpStart!==y&&tmpStart!==tmpEnd)C.firstChild?C.insertBefore(tmpStart,C.firstChild):C.appendChild(tmpStart);else var T=!0;break}C.firstChild?C.insertBefore(d,C.firstChild):C.appendChild(d);var _=g.pop()}else{var _=g.pop(),k="object"==typeof _?r.nodeIndex(_):o,x=tmpStart.childNodes[k]?tmpStart.childNodes[k].nextSibling:void 0,N=tmpStart.cloneNode(!1);for(C.firstChild?C.insertBefore(N,C.firstChild):C.appendChild(N);x;){var S=x.nextSibling;if(e)N.appendChild(x);else{var R=w.cloneNode(!0);N.appendChild(R)}x=S}}C=N,tmpStart=_}for(C=frag;null!==w&&w!==s.lastChild&&w!==tmpEnd;){var S=w.nextSibling;if(e)frag.appendChild(w);else{var R=w.cloneNode(!0);frag.appendChild(R)}w=S}for(w===tmpEnd&&(T=!0),C=frag;"object"==typeof tmpEnd;){if(tmpEnd===y){if(!endType){T&&C.appendChild(tmpEnd);break}C.appendChild(h);var D=b.pop()}else{for(var j=tmpEnd.firstChild,N=tmpEnd.cloneNode(!1),D=b.pop(),L="object"==typeof D?r.nodeIndex(D):a,I=tmpEnd.childNodes[L];j&&j!==I;){var S=j.nextSibling;if(e)N.appendChild(j);else{var R=w.cloneNode(!0);N.appendChild(R)}j=S}C.appendChild(N)}C=N,tmpEnd=D}return e&&(DOMRange._refreshRange(this._index),this.setStart(s,E),this.collapse(!0)),t?frag:void 0},cloneRange:function(){var e=new DOMRange(this._document);e.setStart(this.startContainer,this.startOffset),e.setEnd(this.endContainer,this.endOffset);var t=e._index;return DOMRange._rangeQuery[t]=e,e},insertNode:function(e){if(11!==e.nodeType)return r.isDataNode(this.startContainer)?(r.splitDataNode(this.startContainer,this.startOffset),this.startContainer.parentNode.insertBefore(e,this.startContainer.nextSibling)):this.startContainer.childNodes[this.startOffset]?this.startContainer.insertBefore(e,this.startContainer.childNodes[this.startOffset]):this.startContainer.appendChild(e),DOMRange._refreshRange(this._index),this.setStart(this.startContainer,this.startOffset),this.setEnd(this.startContainer,this.startOffset+1),this.startOffset;var t=e.lastChild,n=e.firstChild;e.lastChild;for(var i=e.childNodes.length;t;){preNode=t.previousSibling;var o=this.insertNode(t);if(t===n)var a=o;t=preNode}if(i){var s=a+i;DOMRange._refreshRange(this._index),this.setStart(this.startContainer,a),this.setEnd(this.startContainer,s)}},surroundContents:function(e){var t=this.extractContents();this.insertNode(e),e.appendChild(t),DOMRange._refreshRange(this._index),this.selectNode(e)},detach:function(){DOMRange._rangeQuery.splice(this._index,1)},createContextualFragment:function(e){var t=(r.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(!1);t.innerHTML=e;for(var n=this._document.createDocumentFragment();t.firstChild;)n.appendChild(t.firstChild);return n},compareBoundaryPoints:function(e,t){var n,r,i,o;switch(e){case DOMRange.START_TO_START:case DOMRange.END_TO_START:n=this.startContainer,r=this.startOffset,3!==n.nodeType&&(r>=n.childNodes.length&&n.lastChild?(n=n.lastChild,r=2147483647):(n=n.childNodes[r],r=-1));break;case DOMRange.END_TO_END:case DOMRange.START_TO_END:n=this.endContainer,r=this.endOffset,3!==n.nodeType&&(r>=n.childNodes.length&&n.lastChild?(n=n.lastChild,r=2147483647):(n=n.childNodes[r],r=-1))}switch(e){case DOMRange.START_TO_START:case DOMRange.START_TO_END:i=t.startContainer,o=t.startOffset,3!==i.nodeType&&(o>=i.childNodes.length&&i.lastChild?(i=i.lastChild,o=2147483647):(i=i.childNodes[o],o=-1));break;case DOMRange.END_TO_START:case DOMRange.END_TO_END:i=t.endContainer,o=t.endOffset,3!==i.nodeType&&(o>=i.childNodes.length&&i.lastChild?(i=i.lastChild,o=2147483647):(i=i.childNodes[o],o=-1))}if(n===i)return o>r?-1:r==o?0:1;var a=this._document.createElement("a"),s=this._document.createElement("a");n.parentNode.insertBefore(a,n),i.parentNode.insertBefore(s,i);var l;return l=a.nextSibling===s?0:a.sourceIndex<s.sourceIndex?-1:1,n.parentNode.removeChild(a),i.parentNode.removeChild(s),l},toString:function(){return i.convertFromDOMRange(this).text},constructor:DOMRange},n.prototype={rangeCount:0,_document:null,_selectionChangeHandler:function(){this.rangeCount=this._selectionExists(this._document.selection.createRange())?1:0},_selectionExists:function(e){try{return 0!=e.compareEndPoints("StartToEnd",e)||e.parentElement().isContentEditable}catch(t){return!1}},addRange:function(e){var t=this._document.body.createTextRange(),n=i.convertFromDOMRange(e);this._selectionExists(t)?n.select():(t.setEndPoint("StartToStart",n),t.setEndPoint("EndToEnd",n),t.select())},removeAllRanges:function(){this._document.selection.empty()},getRangeAt:function(){var e=this._document.selection.createRange(),n=new DOMRange(this._document);if(this._selectionExists(e)){var r=t(e,n),i=r.startContainer.childNodes[r.startOffset],o=r.endContainer.childNodes[r.endOffset-1];if(i){for(;i.nextSibling;){var a=3===i.nodeType?i.nodeValue:i.innerText;if(0!=a.length)break;i=i.nextSibling}for(;i.firstChild;)i=i.firstChild;r.setStart(i,0)}if(o){for(;o.nextSibling;){var a=3===o.nodeType?o.nodeValue:o.innerText;if(0!=a.length)break;o=o.previousSibling}for(;o.lastChild;)o=o.lastChild;3===o.nodeType?r.setEnd(o,o.nodeValue.length):r.setEnd(o,o.childNodes.length)}return r}return null},toString:function(){return this._document.selection.createRange().text}};var o=new n(document);window.getSelection=function(){return window.focus(),o}})();