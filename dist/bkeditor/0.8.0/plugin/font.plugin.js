/*! Bkeditor - v0.8.0 - 2013-05-24
* https://github.com/daixianfeng/a
* Copyright (c) 2013 daixianfeng; Licensed MIT */
(function(e,t){var n={SPAN:!1,EM:!1,STRONG:!1,SUB:!1,SUP:!1},i="";e.addPlugin({id:"font",isEnable:!0,brushOn:{},recordTag:n,recordStyle:i,fontRecord:"",toggleBrush:function(){var t=this.brushOn[e.curId]?!0:!1;this.brushOn[e.curId]=!t,this.brushOn[e.curId]===!0?this.recordStyle():this.fontRecord=""},clear:function(n){var i=e.editWin,r=i.document,o=i.getSelection(),a=o.getRangeAt(0),s=a.commonAncestorContainer,l={ancestor:s,firstNode:a.startContainer,firstOffset:a.startOffset,lastNode:a.endContainer,lastOffset:a.endOffset},c=["td","th","dd","dt"];for(var d in DTD.$block)d=d.toLowerCase(),1===DTD.$block[d]&&c.push(d);c=c.join(",");var u=t(l.lastNode).closest(c)[0],f=a.cloneRange();f.selectNodeContents(u),f.setStart(l.lastNode,l.lastOffset);var m=f.extractContents();f.insertNode(m);var p=t(l.firstNode).closest(c)[0],g=a.cloneRange();g.selectNodeContents(p),g.setEnd(l.firstNode,l.firstOffset);var h=g.extractContents();g.insertNode(h),a.setEnd(f.startContainer,f.startOffset),a.setStart(g.endContainer,g.endOffset);var b=a.cloneRange();b.collapse(!0);var v=a.cloneRange();v.collapse(!1);var y=v.endContainer.childNodes[v.endOffset],w={},s=a.commonAncestorContainer;w=e.IE?r.createNodeIterator(s):r.createNodeIterator(s,NodeFilter.SHOW_ALL);for(var E=w.nextNode(),C=E,T=0,k=1;E;){do C=w.nextNode();while(E===C);if(0===T){var x=r.createRange();x.selectNode(E);var _=x.compareBoundaryPoints(x.START_TO_START,b)}if(1===k)if(C){var N=r.createRange();N.selectNode(C);var S=N.compareBoundaryPoints(N.START_TO_START,v)}else var S=-1;var R=_>-1&&0===T,j=S>-1&&1===k;if(T&&k||R)if(1===E.nodeType&&1===DTD.$font[E.nodeName]){for(var D=E.nextSibling,L=E.parentNode,I=E.childNodes.length,Q=I-1;Q>=0;Q--)D?L.insertBefore(E.childNodes[Q],D):L.appendChild(E.childNodes[Q]);if(y)v.setEndBefore(y),v.collapse(!1);else{var A=v.endContainer.parentNode;v.setEnd(A,A.childNodes.length),v.collapse(!1)}var P=r.createRange();if(P.selectNode(E),P.deleteContents(),R&&(T=1,a.setStart(P.startContainer,P.startOffset)),j){D?a.setEndBefore(D):a.setEnd(L,L.childNodes.length);break}}else if(R&&(T=1,a.setStartBefore(E)),j){a.setEndAfter(E);break}E=C}return o.removeAllRanges(),o.addRange(a),n?a:(e.curEditor.baseFilter.excute("afterTextPre"),e.curEditor.baseFilter.excute("afterText"),void 0)},brush:function(){if(this.brushOn[e.curId]===!0){var t=this.fontRecord,n=this.clear(!0),i=e.editWin,r=i.document,o=i.getSelection(),a=o.getRangeAt(0),s=n.cloneRange();s.collapse(!0);var l=n.cloneRange();l.collapse(!1);var c={},d=n.commonAncestorContainer;c=e.IE?r.createNodeIterator(d,3):r.createNodeIterator(d,NodeFilter.SHOW_TEXT);for(var u=c.nextNode(),f=u,m=0,p=1;u;){if(f=c.nextNode(),0===m){var g=r.createRange();g.selectNode(u);var h=g.compareBoundaryPoints(g.START_TO_START,s)}if(1===p)if(f){var b=r.createRange();b.selectNode(f);var v=b.compareBoundaryPoints(b.START_TO_START,l)}else var v=-1;var y=h>-1&&0===m,w=v>-1&&1===p;if(m&&p||y){var E=r.createRange();if(E.selectNodeContents(u),""!==t.fontStyle){var C=r.createElement("span");C.style.cssText=t.fontStyle,E.surroundContents(C)}for(var T in t.fontTag)if("SPAN"!==T&&t.fontTag[T]===!0){var k=r.createElement(T);E.surroundContents(k)}if(y&&(m=1,a.setStart(E.startContainer,E.startOffset)),w){a.setEnd(E.endContainer,E.endOffset);break}}u=f}o.removeAllRanges(),o.addRange(a)}this.toggleBrush(),e.curEditor.baseFilter.excute("afterTextPre"),e.curEditor.baseFilter.excute("afterText")},recordStyle:function(){for(var i=e.utils.getCurElement(),r=i.length,o=t.extend(!0,{},this.recordTag),a="",s=0;r>s;s++)3!==i[s].nodeType&&n[i[s].nodeName]!==void 0&&(o[i[s].nodeName]=!0,a+=i[s].style.cssText);this.fontRecord={fontTag:o,fontStyle:a}}}),e.addEvent({name:"editareaBrush",type:["mouseup"],area:"editArea",fn:function(){t("#"+e.curId+" .bke-toolbar [cmd=formatmatch].bke-checked").length>0&&e.command("brush")}})})(window.jQuery.jQEditor,window.jQuery);