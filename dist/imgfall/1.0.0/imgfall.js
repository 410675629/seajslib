/* 2013-04-11 */
define("imgfall/1.0.0/image",[],function(e,t){var n=Backbone.Model.extend({defaults:{id:"",url:"",desc:"",comments:"",img_width:"170px",initialize:function(){}}}),a=Backbone.View.extend({initialize:function(){this.render()},render:function(){var e=_.template($("#imgae-container").html(),{image:this.model.attributes});$(this.el).append(e)}}),i=Backbone.Collection.extend({model:n}),l=new i;t.Image=n,t.ImageShow=a,t.imageCollection=l}),define("imgfall/1.0.0/imgfall",["./image","./panel"],function(e,t){var n=e("./image"),a=e("./panel"),i=Backbone.View.extend({initialize:function(){this.render()},render:function(){var e=_.template($("#switch-container").html());$(this.el).append(e)}}),l=Backbone.Model.extend({defaults:{id:"container",dataUrl:"index.php",panel_class:"panel",last_panel_class:"last_panel",per_page:20,panel_count:5,end_distance:20,page:1,del_show:!1,inner_contain:"dl",end_tips:""},initialize:function(){var e=this;e.set("per_panel",parseInt(e.attributes.per_page/(e.attributes.panel_count+1))),e.set("fix_count",e.attributes.per_page-e.attributes.per_panel*e.attributes.panel_count),e.create_panel(e.attributes.panel_count),e.create_pause()},create_panel:function(e){for(var t=this,n={},i={},l={},r=0;e-1>r;r++)n={id:"panel_"+r,classStyle:t.attributes.panel_class},i=new a.Panel(n),l=new a.PanelShow({model:i,el:$("#"+t.attributes.id)});n={id:"panel_"+r,classStyle:t.attributes.last_panel_class},i=new a.Panel(n),l=new a.PanelShow({model:i,el:$("#"+t.attributes.id)})},create_pause:function(){var e=this;panel_div=new i({el:$("#"+e.attributes.id)})},load_image:function(e){var t=this,n=0;if(!e)return this.stop(),!0;var a=e.length;if(t.attributes.per_page>a){for(var i=0;a>i;i++,n++){var l=t.min_height();t.into_panel(e[n],l)}$("#next_page").html("没有了"),this.attributes.end_tips instanceof jQuery&&this.attributes.end_tips.html("没有更多啦"),t.stop()}else{for(var r=0;t.attributes.per_panel>r&&a>n;r++)for(var s=0;t.attributes.panel_count>s;s++,n++)t.into_panel(e[n],s);for(var i=0;t.attributes.fix_count>i;i++,n++){var l=t.min_height();t.into_panel(e[n],l)}t.attributes.page++,t.pause_end()}setTimeout(function(){t.revise(t)},3e3)},into_panel:function(e,t){var a="panel_"+t,i={id:e.id,url:e.photo_url,desc:e.desc,comments:e.comment},l=new n.Image(i);n.imageCollection.add(l),new n.ImageShow({model:l,el:$("#"+a)})},calc_height:function(e){var t="panel_"+e,n=$("#"+t).height();return n},min_height:function(){for(var e=this,t=[],n=0,a=0;e.attributes.panel_count>a;a++)t[a]=e.calc_height(a);for(var a=1;e.attributes.panel_count>a;a++)n=t[n]>t[a]?a:n;return n},max_height:function(){for(var e=this,t=[],n=0,a=0;e.attributes.panel_count>a;a++)t[a]=e.calc_height(a);for(var a=1;e.attributes.panel_count>a;a++)n=t[n]<=t[a]?a:n;return n},ajax_get_image:function(e){var t=this;$.get(t.attributes.dataUrl,{page:e},function(e){t.load_image(e)},"json")},start:function(){var e=this;$(window).bind("scroll",function(){$(document).scrollTop()+$(window).height()>$(document).height()-e.attributes.end_distance&&!e.isPause()})},revise:function(e){for(var t=0;e.attributes.per_page>t;){var n=e.max_height(),a=e.min_height(),i=$("#panel_"+n).height(),l=$("#panel_"+a).height(),r=$("#panel_"+n).find(e.attributes.inner_contain).last(),s=r.height(),o=parseInt(r.css("margin-top"))+parseInt(r.css("margin-bottom"));if(!(i>l+s+o))break;r.appendTo("#panel_"+a),t++}},pause:function(){$("#next_page").html("loading..."),this.attributes.end_tips instanceof jQuery&&this.attributes.end_tips.html("正在加载...")},pause_end:function(){$("#next_page").html("next page"),this.attributes.end_tips instanceof jQuery&&this.attributes.end_tips.html("")},isPause:function(){return"loading..."===$("#next_page").html()},stop:function(){$("#no_more").show(),$(window).unbind("scroll")}}),r=function(e){var t=new l(e);return t.start(),t};t.imgFall=r}),define("imgfall/1.0.0/panel",[],function(e,t){var n=Backbone.Model.extend({defaults:{panel_class:"",initialize:function(){}}}),a=Backbone.View.extend({initialize:function(){this.render()},render:function(){var e=_.template($("#panel-container").html(),{panel:this.model.attributes});$(this.el).append(e)}});t.Panel=n,t.PanelShow=a});